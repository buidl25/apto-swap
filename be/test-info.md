# Чек-лист для разработки бэкенда (Server)

Этот документ описывает шаги для создания и настройки серверных компонентов, необходимых для оркестрации кросс-чейн обмена с использованием новых контрактов escrow и Aptos hackathon_clone.

## 1. Начальная настройка проекта (NestJS)

- [x] Инициализировать NestJS проект (уже сделано).
- [x] Настроить подключение к базе данных (PostgreSQL) через Prisma.
- [ ] Обновить переменные окружения в `.env` для работы с новыми контрактами:
  - URL для RPC EVM и Aptos
  - Приватный ключ ретранслятора
  - Строка подключения к БД
  - Адреса контрактов EscrowFactory и FusionResolver
  - Адрес модуля Aptos hackathon_clone
- [ ] Обновить модуль конфигурации (`ConfigModule`) для доступа к новым переменным окружения.

## 2. Модель данных и сервис для управления состоянием (Prisma)

- [ ] Обновить модель `Swap` в файле `prisma/schema.prisma` для работы с новыми контрактами:
  - `id` (уникальный идентификатор свопа)
  - `status` (обновленные статусы: `PENDING`, `EVM_ESCROW_CREATED`, `APTOS_ESCROW_CREATED`, `USER_WITHDREW_APTOS`, `COMPLETED`, `FAILED`, `REFUNDED`, `CANCELLED`)
  - `userEvmAddress` (maker в EVM)
  - `userAptosAddress` (taker в Aptos)
  - `secretHash` (хеш секрета для escrow)
  - `secret` (будет `null` до раскрытия)
  - `orderHash` (хеш ордера для идентификации escrow)
  - `evmTxHash` (хеш транзакции создания escrow в EVM)
  - `aptosTxHash` (хеш транзакции создания escrow в Aptos)
  - `escrowAddress` (адрес созданного escrow контракта)
  - `tokenAddress` (адрес ERC20 токена)
  - `amount` (сумма ERC20 токенов)
  - `safetyDeposit` (сумма ETH для безопасного депозита)
  - `timelocks` (временные блокировки для escrow)
  - `createdAt`
  - `updatedAt`
- [x] Сгенерировать клиент Prisma (`npx prisma generate`).
- [ ] Обновить сервис `SwapService` для работы с новыми контрактами.

## 3. Сервисы для работы с блокчейнами

- [ ] Обновить сервис `EvmService` для работы с новыми escrow контрактами:
  - Подключение к RPC через ethers.js
  - Взаимодействие с EscrowFactory и FusionResolver
  - Создание и мониторинг escrow контрактов
  - Отслеживание событий раскрытия секрета
- [ ] Обновить сервис `AptosService` для работы с hackathon_clone модулем:
  - Подключение к Aptos API
  - Создание escrow в Aptos
  - Проверка состояния escrow
  - Отслеживание событий раскрытия секрета

## 4. Сервис для интеграции с 1inch Fusion

-   [x] Создать `FusionService`.
-   [x] Реализовать метод `submitOrder(signedOrder)`, который отправляет подписанный ордер в API 1inch Fusion.
-   [x] Реализовать метод для мониторинга статуса ордера в 1inch (если их API это поддерживает, либо через мониторинг транзакции).

## 5. API-контроллер для взаимодействия с фронтендом

-   [x] Создать `SwapController` с основными эндпоинтами.
-   [x] **`POST /swap/initiate`**:
    -   Принимает подписанный ордер 1inch Fusion и `preimageHash` от фронтенда.
    -   Проводит валидацию входящих данных (DTO).
    -   Вызывает сервис для начала процесса обмена.
-   [x] **`GET /swap/status/:id`**:
    -   Позволяет фронтенду запрашивать текущий статус свопа по его ID.

## 6. Сервис для работы с EVM-блокчейном
-   [x] Реализовать метод `submitOrder(signedOrder)`, который отправляет подписанный ордер в API 1inch Fusion.
-   [x] Реализовать метод для мониторинга статуса ордера в 1inch (если их API это поддерживает, либо через мониторинг транзакции).

## 5. Сервис для работы с EVM-блокчейном

-   [x] Создать `EvmService`.
-   [x] Настроить подключение к EVM-сети через `ethers.js` или `viem`.
-   [x] Реализовать **слушателя событий (event listener)** для контракта `EVM HTLC`.
    -   Слушать событие `NewContract(..., bytes32 hash, ...)`.
    -   При получении события, изв��екать данные и передавать их в главный сервис-оркестратор.
-   [x] Реализовать метод `withdraw(preimage)`, который будет выз��вать функцию `withdraw` на EVM HTLC контракте, используя приватный ключ ретранслятора.

## 6. Сервис для работы с Aptos-блокчейном (Relayer)

-   [x] Создать `AptosService`.
-   [x] Настроить подключение к Aptos-сети через Aptos SDK.
-   [x] Использовать **приватный ключ ретранслятора (сервера)** для подписи транзакций.
-   [x] Реализовать метод `createHtlc(hash, userAptosAddress, amount, ...)` для создания HTLC на стороне Aptos.
-   [x] Реализовать **механизм отслеживания** раскрытия секрета на стороне Aptos (через опрос событий withdrawn_events).
    -   [x] Цель: получить `preimage`, когда пользователь выведет средства.

 

## 8. Обработка ошибок и крайних случаев

-   [ ] Реализовать логику для отмены (refund) по истечении тайм-аута.
-   [ ] Добавить обработку ошибок на всех этапах (ошибка отправки транзакции, недостаток газа и т.д.).
-   [ ] Настроить логирование для отладки и мониторинга.
